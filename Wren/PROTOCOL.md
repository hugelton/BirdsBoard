# Wren DCO シリアルプロトコル仕様 v3.0

## 概要
バイナリベースのプロトコルで、テキストコマンドとリアルタイムデータの誤認を防止。
全てのコマンドは固定長のバイナリフォーマットで送信。

## 基本仕様
- **ボーレート**: 115200 bps
- **データ形式**: バイナリ (HEX)
- **エンディアン**: Little Endian
- **応答**: 固定長バイナリまたは無応答

---

## コマンド一覧

### 1. PING - 接続テスト
```
送信: 0x01
応答: 0xA1
```

### 2. BANK - 編集対象バンク変更
```
送信: 0x02 <bank>
応答: 0xA2

例: バンク5を編集対象に設定
送信: 0x02 0x05
応答: 0xA2
```
- `<bank>`: 0-7 (バンク番号)
- 編集対象バンクを変更（再生バンクは変更されない）

### 3. SAVE - バンク保存
```
送信: 0x03 <bank>
応答: 0xA3

例: バンク3を EEPROM に保存
送信: 0x03 0x03
応答: 0xA3
```
- `<bank>`: 0-7 (保存するバンク番号)
- 指定バンクの wavetable を EEPROM に永続保存

### 4. DUMP - バンクダンプ
```
送信: 0x04 <bank>
応答: 0xA4 + [64 bytes wavetable data]

例: バンク2をダンプ
送信: 0x04 0x02
応答: 0xA4 + 64バイトのwavetableデータ
```
- `<bank>`: 0-7 (ダンプするバンク番号)
- 指定バンクの wavetable データを返送

### 5. REALTIME - リアルタイム編集
```
送信: 0x05 + [64 bytes wavetable data]
応答: なし

例: リアルタイム波形更新
送信: 0x05 + 64バイトの新しい波形データ
応答: (無応答)
```
- 現在の編集対象バンク (`BANK` コマンドで設定) を更新
- 編集対象バンクが再生中の場合、即座に音に反映

### 6. MODTYPE - モジュレーションタイプ設定 (NEW)
```
送信: 0x06 <bank> <modulation_type>
応答: 0xA6

例: バンク2にPhase Distortionを設定
送信: 0x06 0x02 0x03
応答: 0xA6
```
- `<bank>`: 0-7 (対象バンク番号)
- `<modulation_type>`: 0-4 (モジュレーションタイプ)
  - 0: Wavefolding (デフォルト)
  - 1: Overflow
  - 2: Bitcrush
  - 3: Phase Distortion
  - 4: Resonance (CZ-101方式)
- バンク別にモジュレーション方式を設定
- 設定は自動的にEEPROMに保存

---

## データフォーマット

### Wavetable データ (64 bytes)
```
Byte 0-1:   Sample 0  (16-bit Little Endian)
Byte 2-3:   Sample 1  (16-bit Little Endian)
Byte 4-5:   Sample 2  (16-bit Little Endian)
...
Byte 62-63: Sample 31 (16-bit Little Endian)
```

### サンプル値
- **0x0000 (0)**: 最小値 (負の波形)
- **0x8000 (32768)**: ゼロクロス (中央値)
- **FFFF (65535)**: 最大値 (正の波形)

---

## 使用例

### 1. 接続確認
```
PC → DCO: 0x01
DCO → PC: 0xA1
```

### 2. バンク3を編集してリアルタイム更新
```
PC → DCO: 0x02 0x03        (編集対象をバンク3に設定)
DCO → PC: 0xA2             (OK)

PC → DCO: 0x05 + [64 bytes] (新しい波形データを送信)
DCO → PC: (無応答)          (即座に反映)
```

### 3. 編集した波形を保存
```
PC → DCO: 0x03 0x03        (バンク3を保存)
DCO → PC: 0xA3             (OK)
```

### 4. バンクデータの読み込み
```
PC → DCO: 0x04 0x05        (バンク5をダンプ)
DCO → PC: 0xA4 + [64 bytes] (バンク5のデータ)
```

---

## エラーハンドリング

### 無効なコマンド
```
送信: 0xFF (未定義コマンド)
応答: 0xE0 (エラー)
```

### 無効なバンク番号
```
送信: 0x02 0x0A (バンク10 - 範囲外)
応答: 0xE1 (範囲エラー)
```

### タイムアウト
- 応答が 1 秒以内に返らない場合は通信エラー
- 再接続を推奨

---

## モジュレーション詳細

### モジュレーションタイプ

1. **Wavefolding (0)** - デフォルト
   - 従来のウェーブフォールディング
   - CV2で強度制御 (0-100%)

2. **Overflow (1)**
   - 信号が±1.0を超えた時にラップアラウンド
   - CV2でオーバーフロー量制御

3. **Bitcrush (2)**
   - ビット深度を意図的に下げてデジタル歪み
   - CV2でビット深度制御 (16bit→4bit)

4. **Phase Distortion (3)**
   - CASIO風位相歪み合成
   - CV2で歪み量制御
   - fastSinテーブル使用で高速処理

5. **Resonance (4)**
   - CZ-101風レゾナント合成
   - CV2でレゾナント周波数制御 (1x-8x)
   - ハードシンクによるエイリアス防止

### バンク別設定
- 各バンクに個別のモジュレーションタイプを設定可能
- CV1でバンク切り替え時に自動的にモジュレーションも切り替わる
- 設定はEEPROMに永続保存

## 利点

1. **誤認防止**: 全てのコマンドが 0x01-0x06 で開始、wavetable データと明確に区別
2. **高速処理**: バイナリ形式で解析が高速
3. **固定長**: コマンド長が予測可能
4. **拡張性**: 新しいコマンドを簡単に追加可能
5. **バンク別制御**: モジュレーションをバンク毎に独立設定

---

## 実装ノート

### 現在の動作
- **編集バンク**: `BANK` コマンドで制御
- **再生バンク**: CV1 で制御  
- **LED表示**: 再生バンクの色を表示
- **リアルタイム編集**: 編集バンクが再生中の場合のみ音に反映

### シリアル処理
```cpp
if (data >= 0x01 && data <= 0x06) {
    // コマンド処理
} else {
    // 不正データ - エラー応答
}
```

### 新機能使用例

#### バンク別モジュレーション設定
```
// バンク0: Wavefolding (デフォルト)
PC → DCO: 0x06 0x00 0x00
DCO → PC: 0xA6

// バンク1: Phase Distortion
PC → DCO: 0x06 0x01 0x03
DCO → PC: 0xA6

// バンク2: Resonance
PC → DCO: 0x06 0x02 0x04
DCO → PC: 0xA6
```

#### エラーケース
```
// 無効なモジュレーションタイプ
PC → DCO: 0x06 0x00 0x05  (タイプ5は無効)
DCO → PC: 0xE1            (範囲エラー)

// 無効なバンク
PC → DCO: 0x06 0x08 0x00  (バンク8は無効)
DCO → PC: 0xE1            (範囲エラー)
```